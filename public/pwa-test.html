<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Test Page</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#800020">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --maroon-primary: #800020;
            --maroon-secondary: #a0002a;
            --maroon-dark: #600018;
            --maroon-light: rgba(128, 0, 32, 0.1);
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .online { background-color: #28a745; }
        .offline { background-color: #dc3545; }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .card-header {
            background: linear-gradient(135deg, var(--maroon-primary) 0%, var(--maroon-secondary) 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1.25rem;
        }
        .btn-primary {
            background-color: var(--maroon-primary);
            border-color: var(--maroon-primary);
        }
        .btn-primary:hover {
            background-color: var(--maroon-dark);
            border-color: var(--maroon-dark);
        }
        .test-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 10px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        #install-button, #mobile-install-button {
            font-weight: 600;
            border-radius: 8px;
            padding: 12px 24px;
            transition: all 0.3s ease;
        }
        
        #install-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        
        #mobile-install-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108,117,125,0.3);
        }
        
        #installation-status {
            border-radius: 8px;
            font-weight: 500;
        }
        
        .installation-step {
            background: #e9ecef;
            border-left: 4px solid #007bff;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .device-instructions {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .install-prompt {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--maroon-light);
            border-radius: 8px;
            border: 1px solid rgba(128, 0, 32, 0.2);
        }
        .install-steps {
            margin-top: 1rem;
            padding-left: 1.5rem;
        }
        .install-steps li {
            margin-bottom: 0.5rem;
        }
        .platform-specific {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">PWA Installation & Offline Test</h3>
                        <p class="mb-0" id="connection-status">
                            <span class="status-indicator online"></span>
                            <span id="status-text">Online</span>
                        </p>
                    </div>
                    <div class="card-body">
                        <div class="test-section">
                            <h5>1. Service Worker Status</h5>
                            <p id="sw-status">Checking...</p>
                            <button class="btn btn-sm btn-outline-secondary" onclick="checkServiceWorker()">Check Again</button>
                        </div>
                        
                        <div class="test-section">
                            <h5>2. PWA Installation</h5>
                            <div id="install-instructions">
                                <div class="d-grid gap-2 mb-3">
                                    <button id="install-button" class="btn btn-primary" style="display: none;">Install App</button>
                                    <button id="mobile-install-button" class="btn btn-outline-primary" style="display: none;">Install on Mobile Device</button>
                                </div>
                                <div id="installation-status" class="alert" style="display: none;"></div>
                                <div id="manual-install-instructions">
                                    <div class="alert alert-info">
                                        <h6><i class="bi bi-info-circle"></i> Important: Proper PWA Installation</h6>
                                        <p class="mb-2">For full PWA features (offline mode, push notifications, etc.), you need to <strong>install</strong> the app, not just bookmark it.</p>
                                        
                                        <div id="android-instructions" style="display: none;">
                                            <p><strong>Android Chrome/Edge:</strong></p>
                                            <ol class="mb-2">
                                                <li>Tap the menu button (⋮) in the browser</li>
                                                <li>Select "<strong>Install app</strong>" or "<strong>Add to Home screen</strong>"</li>
                                                <li>Tap "<strong>Install</strong>" in the popup (not just "Add")</li>
                                                <li>Look for the app icon on your home screen</li>
                                            </ol>
                                        </div>
                                        
                                        <div id="ios-instructions" style="display: none;">
                                            <p><strong>iOS Safari:</strong></p>
                                            <ol class="mb-2">
                                                <li>Tap the share button <i class="bi bi-share"></i></li>
                                                <li>Scroll down and tap "<strong>Add to Home Screen</strong>"</li>
                                                <li>Tap "<strong>Add</strong>" to install</li>
                                                <li>The app will appear on your home screen</li>
                                            </ol>
                                        </div>
                                        
                                        <div id="desktop-instructions" style="display: none;">
                                            <p><strong>Desktop Chrome/Edge:</strong></p>
                                            <ol class="mb-2">
                                                <li>Look for the install icon <i class="bi bi-download"></i> in the address bar</li>
                                                <li>Click it and select "Install"</li>
                                                <li>Or use the "Install App" button above</li>
                                            </ol>
                                        </div>
                                        
                                        <p class="mb-0"><small><strong>Note:</strong> Once properly installed, the app will work offline and provide native app-like experience.</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="test-section">
                            <h5>3. Offline Test</h5>
                            <p>To test offline functionality:</p>
                            <ol>
                                <li>Install the app using the instructions above</li>
                                <li>Turn off your Wi-Fi and mobile data</li>
                                <li>Open the installed app from your home screen</li>
                                <li>The app should load and show cached content</li>
                            </ol>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="testOffline()">Test Offline Mode Now</button>
                            </div>
                            <div id="offline-test-result" class="mt-3"></div>
                        </div>
                        
                        <div class="test-section">
                            <h5>4. Cache Status</h5>
                            <p id="cache-status">Checking cache...</p>
                            <button class="btn btn-sm btn-outline-secondary" onclick="checkCaches()">Check Cache</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check online/offline status
        function updateConnectionStatus() {
            const indicator = document.querySelector('.status-indicator');
            const statusText = document.getElementById('status-text');
            
            if (navigator.onLine) {
                indicator.className = 'status-indicator online';
                statusText.textContent = 'Online';
            } else {
                indicator.className = 'status-indicator offline';
                statusText.textContent = 'Offline';
            }
        }
        
        // Check service worker status
        function checkServiceWorker() {
            const swStatus = document.getElementById('sw-status');
            swStatus.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div> Checking...';
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    if (registration) {
                        swStatus.innerHTML = `<span class="text-success"><i class="bi bi-check-circle-fill me-2"></i>Service Worker registered and active</span>`;
                        console.log('Service Worker registered:', registration);
                    } else {
                        swStatus.innerHTML = `<span class="text-warning"><i class="bi bi-exclamation-triangle-fill me-2"></i>Service Worker not registered</span>`;
                    }
                }).catch(error => {
                    swStatus.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle-fill me-2"></i>Service Worker error: ${error.message}</span>`;
                });
            } else {
                swStatus.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle-fill me-2"></i>Service Workers not supported</span>';
            }
        }
        
        // Check cache status
        async function checkCaches() {
            const cacheStatus = document.getElementById('cache-status');
            cacheStatus.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div> Checking cache...';
            
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    if (cacheNames.length > 0) {
                        let cacheInfo = '<span class="text-success"><i class="bi bi-check-circle-fill me-2"></i>Caches found:</span><ul>';
                        for (const name of cacheNames) {
                            const cache = await caches.open(name);
                            const keys = await cache.keys();
                            cacheInfo += `<li>${name}: ${keys.length} items</li>`;
                        }
                        cacheInfo += '</ul>';
                        cacheStatus.innerHTML = cacheInfo;
                    } else {
                        cacheStatus.innerHTML = '<span class="text-warning"><i class="bi bi-exclamation-triangle-fill me-2"></i>No caches found</span>';
                    }
                } catch (error) {
                    cacheStatus.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle-fill me-2"></i>Error checking caches: ${error.message}</span>`;
                }
            } else {
                cacheStatus.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle-fill me-2"></i>Cache API not supported</span>';
            }
        }
        
        // Test offline functionality
        function testOffline() {
            const resultDiv = document.getElementById('offline-test-result');
            resultDiv.innerHTML = '<div class="alert alert-info"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Testing offline functionality...</div>';
            
            // Simulate going offline
            setTimeout(() => {
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <strong>Test Passed!</strong> Service Worker is active and controlling this page.
                            <hr>
                            <p class="mb-0">To fully test offline functionality:</p>
                            <ol class="mb-0">
                                <li>Turn off your Wi-Fi and mobile data</li>
                                <li>Refresh this page or navigate to another page</li>
                                <li>The app should still work with cached content</li>
                            </ol>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>Test Failed!</strong> Service Worker is not controlling this page.
                            <hr>
                            <p>Please make sure:</p>
                            <ol class="mb-0">
                                <li>You've visited the site at least twice (for SW to activate)</li>
                                <li>You're using a supported browser (Chrome, Edge, Firefox, Safari)</li>
                                <li>The site is served over HTTPS (or localhost)</li>
                            </ol>
                        </div>
                    `;
                }
            }, 1500);
        }
        
        // Enhanced PWA installation handling
        let deferredPrompt;
        const installButton = document.getElementById('install-button');
        const mobileInstallButton = document.getElementById('mobile-install-button');
        const installationStatus = document.getElementById('installation-status');
        
        // Device detection
        function detectDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isAndroid = userAgent.includes('android');
            const isIOS = /iphone|ipad|ipod/.test(userAgent);
            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/.test(userAgent);
            const isChrome = userAgent.includes('chrome');
            const isSafari = userAgent.includes('safari') && !userAgent.includes('chrome');
            
            return { isAndroid, isIOS, isMobile, isChrome, isSafari };
        }
        
        // Show appropriate installation instructions
        function showInstallInstructions() {
            const device = detectDevice();
            
            if (device.isAndroid) {
                document.getElementById('android-instructions').style.display = 'block';
            } else if (device.isIOS) {
                document.getElementById('ios-instructions').style.display = 'block';
            } else {
                document.getElementById('desktop-instructions').style.display = 'block';
            }
        }
        
        // Show installation status
        function showInstallStatus(message, type = 'info') {
            installationStatus.className = `alert alert-${type}`;
            installationStatus.textContent = message;
            installationStatus.style.display = 'block';
        }
        
        // Handle beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            const device = detectDevice();
            
            if (device.isMobile) {
                // Show both buttons for mobile
                installButton.style.display = 'block';
                mobileInstallButton.style.display = 'block';
                showInstallStatus('App can be installed! Use the buttons above or follow the manual instructions below.', 'success');
            } else {
                // Show only main install button for desktop
                installButton.style.display = 'block';
                showInstallStatus('App can be installed! Click the "Install App" button above.', 'success');
            }
        });
        
        // Main install button handler
        installButton.addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                        showInstallStatus('Installation started! The app will appear on your home screen shortly.', 'success');
                        installButton.textContent = 'Installing...';
                        installButton.disabled = true;
                    } else {
                        console.log('User dismissed the install prompt');
                        showInstallStatus('Installation cancelled. You can try again anytime.', 'warning');
                    }
                    deferredPrompt = null;
                });
            } else {
                showInstallStatus('Installation prompt not available. Please use manual installation instructions below.', 'info');
            }
        });
        
        // Mobile-specific install button
        mobileInstallButton.addEventListener('click', () => {
            const device = detectDevice();
            
            if (device.isIOS) {
                showInstallStatus('For iOS: Tap the Share button and select "Add to Home Screen"', 'info');
                document.getElementById('ios-instructions').scrollIntoView({ behavior: 'smooth' });
            } else if (device.isAndroid) {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            showInstallStatus('Installation started! Look for the app icon on your home screen.', 'success');
                        } else {
                            showInstallStatus('For Android: Tap the menu (⋮) and select "Install app"', 'info');
                            document.getElementById('android-instructions').scrollIntoView({ behavior: 'smooth' });
                        }
                    });
                } else {
                    showInstallStatus('For Android: Tap the menu (⋮) and select "Install app"', 'info');
                    document.getElementById('android-instructions').scrollIntoView({ behavior: 'smooth' });
                }
            }
        });
        
        // Check if already installed
        window.addEventListener('appinstalled', (evt) => {
            installButton.textContent = 'App Installed!';
            installButton.disabled = true;
            mobileInstallButton.style.display = 'none';
            showInstallStatus('App successfully installed! You can now use it offline.', 'success');
            console.log('INSTALL: Success');
        });
        
        // Initialize on page load
        showInstallInstructions();
        
        // Check installation status and provide feedback
        function checkInstallationStatus() {
            const device = detectDevice();
            const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost';
            const isIP = /^\d+\.\d+\.\d+\.\d+$/.test(window.location.hostname);
            
            // Check if running as installed PWA
            const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone === true ||
                               document.referrer.includes('android-app://');
            
            if (isInstalled) {
                // App is already installed
                installButton.style.display = 'none';
                mobileInstallButton.style.display = 'none';
                showInstallStatus('✅ App is already installed and running in standalone mode!', 'success');
                
                document.getElementById('install-instructions').innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="bi bi-check-circle"></i> PWA Successfully Installed!</h6>
                        <p class="mb-2">You're currently using the installed version of this app.</p>
                        <p class="mb-2"><strong>Features available:</strong></p>
                        <ul class="mb-2">
                            <li>✅ Offline functionality</li>
                            <li>✅ Native app-like experience</li>
                            <li>✅ Home screen icon</li>
                            <li>✅ Push notifications (when implemented)</li>
                            <li>✅ Background sync</li>
                        </ul>
                        <p class="mb-0"><small>You can now use this app even without internet connection!</small></p>
                    </div>
                `;
                return true;
            }
            
            // Check for HTTPS requirement
            if (!isSecure && isIP) {
                showInstallStatus('⚠️ PWA installation requires HTTPS when accessing via IP address', 'warning');
                document.getElementById('install-instructions').innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle"></i> HTTPS Required for IP Access</h6>
                        <p class="mb-2">PWA installation is not available when accessing via IP address over HTTP.</p>
                        <p class="mb-2"><strong>Solutions:</strong></p>
                        <ol class="mb-2">
                            <li><strong>Use localhost:</strong> Access via <code>http://localhost:8000/pwa-test.html</code></li>
                            <li><strong>Set up HTTPS:</strong> Use a reverse proxy with SSL certificate</li>
                            <li><strong>Use ngrok:</strong> Create a secure tunnel to your local server</li>
                        </ol>
                        <p class="mb-2"><strong>Alternative for mobile testing:</strong></p>
                        <div class="alert alert-info mb-2">
                            <p class="mb-1"><strong>Manual Installation (Limited Features):</strong></p>
                            <p class="mb-1">• Android Chrome: Menu (⋮) → "Add to Home screen"</p>
                            <p class="mb-0">• iOS Safari: Share → "Add to Home Screen"</p>
                        </div>
                        <p class="mb-0"><small><strong>Note:</strong> Manual installation won't provide full PWA features like service worker and offline functionality.</small></p>
                    </div>
                `;
                return false;
            }
            
            // Check if installation is supported
            if ('serviceWorker' in navigator && 'BeforeInstallPromptEvent' in window) {
                // Installation is supported but not yet triggered
                if (!deferredPrompt) {
                    showInstallStatus('App installation is supported. Waiting for installation prompt...', 'info');
                }
            } else if (device.isIOS && device.isSafari) {
                // iOS Safari - manual installation only
                showInstallStatus('On iOS Safari, use manual installation via Share → Add to Home Screen', 'info');
                mobileInstallButton.style.display = 'block';
            } else {
                // Installation not supported
                showInstallStatus('PWA installation not supported on this browser/device.', 'warning');
            }
            
            return false;
        }
        
        // Enhanced detection for already installed PWAs
        function detectInstalledPWA() {
            // Multiple ways to detect if PWA is installed
            const standalone = window.matchMedia('(display-mode: standalone)').matches;
            const fullscreen = window.matchMedia('(display-mode: fullscreen)').matches;
            const minimalUi = window.matchMedia('(display-mode: minimal-ui)').matches;
            const iosStandalone = window.navigator.standalone === true;
            const androidApp = document.referrer.includes('android-app://');
            
            return standalone || fullscreen || minimalUi || iosStandalone || androidApp;
        }
        
        // Initialize installation status check
        setTimeout(() => {
            if (!checkInstallationStatus()) {
                // Not installed, show appropriate instructions
                const device = detectDevice();
                if (device.isMobile && !deferredPrompt) {
                    mobileInstallButton.style.display = 'block';
                }
            }
        }, 1000);
        
        // Check if running as installed PWA
        if (detectInstalledPWA()) {
            document.getElementById('install-instructions').innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>Success!</strong> App is running in standalone mode.
                </div>
            `;
        }
        
        // Register service worker if not already registered
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('SW registered:', registration);
                    // Check service worker status after registration
                    setTimeout(checkServiceWorker, 1000);
                })
                .catch(error => {
                    console.log('SW registration failed:', error);
                });
        }
        
        // Initial checks
        window.addEventListener('load', () => {
            updateConnectionStatus();
            checkServiceWorker();
            checkCaches();
        });
        
        // Listen for online/offline events
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
    </script>
</body>
</html>